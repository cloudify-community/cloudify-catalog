---

- hosts: all
  become: yes
  vars:
    - mysql_root_password: "{{ pb_root_password }}"
    - mysql_app_user: "{{ pb_appuser }}"
    - mysql_app_user_password: "{{ pb_appuser_password }}" 
    - mysql_repo_url: http://repo.mysql.com/mysql80-community-release-el7.rpm
 

  tasks:
    - name: Enable MySQL Community Repository - CentOS
      ansible.builtin.yum:
        name: "{{ mysql_repo_url }}"
        state: present
        disable_gpg_check: "yes"
  
    - name: Ensure MySQL packages are installed.
      ansible.builtin.yum:
        name:
          - mysql-community-server
          - MySQL-python
        state: present
        disable_gpg_check: "yes"
    
    - name: Ensure MySQL is started
      ansible.builtin.systemd:
        name: mysqld
        state: started
        enabled: true

    - name: Get temporary root password generated by the installation
      shell: 
        cmd: grep -i 'temporary password' /var/log/mysqld.log  | awk '{print $NF}' 
      register: mysql_root_password_temp

    - name: Set new root password from default temporary password
      shell: "mysql -e \"SET PASSWORD = '{{ mysql_root_password }}';\" --connect-expired-password -uroot -p'{{ mysql_root_password_temp.stdout }}' && touch /root/.my.password.changed"
      args:
        creates: /root/.my.password.changed

    - name: Ensure root can login into MySQL localhost
      shell: "mysql -e \"CREATE USER 'root'@'{{ item }}';\" -uroot -p'{{ mysql_root_password }}'"
      with_items:
        - ::1
        - 127.0.0.1
        - localhost
      ignore_errors: yes
  
    - name: Create app_user and allow access from outside, with authentication plugin as mysql_native_password.
      shell: "mysql -e \"CREATE USER '{{ mysql_app_user}}'@'%' IDENTIFIED WITH mysql_native_password BY '{{mysql_app_user_password}}'; GRANT ALL PRIVILEGES ON *.* TO '{{ mysql_app_user }}'@'%';\" -uroot -p'{{mysql_root_password}}'"
      
    - name: Restart the MySQL service
      ansible.builtin.systemd:
        name: mysqld
        state: restarted

